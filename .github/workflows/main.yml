name: CI/CD Pipeline - Spring Boot

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  build-test-analyze-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: maven

      - name: Build & Analyze (SonarCloud)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
            -Dsonar.organization=cammedel \
            -Dsonar.projectKey=cammedel_Prueba2 \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Snyk CLI
        run: npm install -g snyk

      - name: Authenticate Snyk CLI
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk auth $SNYK_TOKEN

      - name: Snyk test Java dependencies
        continue-on-error: true
        run: |
          echo "üîç Ejecutando an√°lisis de vulnerabilidades..."
          snyk test --file=pom.xml --package-manager=maven --severity-threshold=high

      - name: Build Docker image
        run: docker build -t prueba2-app -f deployment/Dockerfile .

      - name: Start Docker stack
        working-directory: deployment
        run: |
          # Crear red si no existe
          docker network create deployment-observabilidad_monitoring || true
          
          # Limpiar contenedores anteriores
          docker compose down -v || true
          
          echo "üöÄ Levantando servicios..."
          # Intentar levantar servicios. Si falla, mostrar logs de Oracle para depurar.
          docker compose up -d || (echo "‚ùå Error al levantar Docker. Mostrando logs de Oracle:" && docker compose logs oracle-db && exit 1)
          cd deployment-observabilidad
          docker compose up -d
         

      # Script corregido para verificar salud de servicios
      - name: Wait and Check Services Health
        run: |
          wait_for_service() {
            local service_name=$1
            local url=$2
            local max_attempts=15 # 15 intentos * 5 segundos = 75 segundos
            local wait_time=5
            local current_attempt=0

            echo "‚è≥ Esperando a que ${service_name} ($url) arranque. M√°x ${max_attempts} intentos."

            while [ $current_attempt -lt $max_attempts ]; do
              # --fail hace que curl falle si el HTTP code es error
              curl -s --fail $url > /dev/null 2>&1
              
              if [ $? -eq 0 ]; then
                echo "‚úÖ ${service_name} est√° listo."
                return 0
              fi
              
              current_attempt=$((current_attempt + 1))
              echo "Reintento $current_attempt/${max_attempts}. ${service_name} no responde. Esperando ${wait_time}s..."
              sleep $wait_time
            done

            echo "‚ùå Error: ${service_name} no arranc√≥ en el tiempo l√≠mite."
            return 1
          }

          echo "üè• Verificando estado de los servicios de monitoreo..."
          
          # Verificar Prometheus
          wait_for_service "Prometheus" "http://localhost:9090/-/healthy"
          if [ $? -ne 0 ]; then exit 1; fi
          
          # Verificar Grafana
          wait_for_service "Grafana" "http://localhost:3000/api/health"
          if [ $? -ne 0 ]; then exit 1; fi

          echo "Todos los servicios de monitoreo est√°n respondiendo correctamente."

      - name: Clean up
        if: always()
        working-directory: deployment
        run: docker compose down -v
